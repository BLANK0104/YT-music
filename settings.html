<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';">
    <title>YouTube Music Settings</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            overflow-x: hidden;
        }

        .settings-container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 300;
        }

        .setting-group {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .setting-group h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            color: #4ecdc4;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .setting-label h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 500;
        }

        .setting-label p {
            margin: 0;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.3);
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .range-slider {
            width: 100px;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            cursor: pointer;
        }

        .range-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            cursor: pointer;
            border: none;
        }

        .eq-container {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
        }

        .eq-band {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .eq-slider {
            width: 6px;
            height: 120px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            writing-mode: bt-lr;
        }

        .eq-label {
            margin-top: 10px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }

        .btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.3);
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn.secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 20px rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <h1>‚öôÔ∏è YouTube Music Settings</h1>

        <div class="setting-group">
            <h3>üéµ Playback Features</h3>
            
            <div class="setting-item">
                <div class="setting-label">
                    <h4>Background Play</h4>
                    <p>Keep playing music when window is minimized</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="backgroundPlay" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>Auto Pause on Interruption</h4>
                    <p>Pause music when system sounds play</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoPauseOnInterruption" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>Crossfade</h4>
                    <p>Smooth transitions between tracks</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="crossfade">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>Gapless Playback</h4>
                    <p>Seamless playback between tracks</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="gaplessPlayback" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="setting-group">
            <h3>üñ•Ô∏è System Integration</h3>
            
            <div class="setting-item">
                <div class="setting-label">
                    <h4>Start with Windows</h4>
                    <p>Launch app automatically when Windows starts</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="startWithWindows">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>System Tray</h4>
                    <p>Show app icon in system tray</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="systemTray" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>Media Keys</h4>
                    <p>Control playback with keyboard media keys</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="mediaKeys" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>Discord Rich Presence</h4>
                    <p>Show what you're listening to in Discord</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="discordRichPresence">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="setting-group">
            <h3>üîä Audio Enhancement</h3>
            
            <div class="setting-item">
                <div class="setting-label">
                    <h4>Equalizer</h4>
                    <p>Enable audio equalizer</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="equalizerEnabled">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>Audio Normalization</h4>
                    <p>Normalize volume levels across tracks</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="audioNormalization" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>Bass Boost</h4>
                    <p>Enhance low frequencies (0-10)</p>
                </div>
                <input type="range" class="range-slider" id="bassBoost" min="0" max="10" value="0">
            </div>
        </div>

        <div class="setting-group">
            <h3>üéõÔ∏è Equalizer Bands</h3>
            <div class="eq-container">
                <div class="eq-band">
                    <input type="range" class="eq-slider" id="eq60" min="-12" max="12" value="0" orient="vertical" oninput="updateEQBand('eq60', this.value)">
                    <div class="eq-label">60Hz</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" id="eq170" min="-12" max="12" value="0" orient="vertical" oninput="updateEQBand('eq170', this.value)">
                    <div class="eq-label">170Hz</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" id="eq310" min="-12" max="12" value="0" orient="vertical" oninput="updateEQBand('eq310', this.value)">
                    <div class="eq-label">310Hz</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" id="eq600" min="-12" max="12" value="0" orient="vertical" oninput="updateEQBand('eq600', this.value)">
                    <div class="eq-label">600Hz</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" id="eq1k" min="-12" max="12" value="0" orient="vertical" oninput="updateEQBand('eq1k', this.value)">
                    <div class="eq-label">1kHz</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" id="eq3k" min="-12" max="12" value="0" orient="vertical" oninput="updateEQBand('eq3k', this.value)">
                    <div class="eq-label">3kHz</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" id="eq6k" min="-12" max="12" value="0" orient="vertical" oninput="updateEQBand('eq6k', this.value)">
                    <div class="eq-label">6kHz</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" id="eq12k" min="-12" max="12" value="0" orient="vertical" oninput="updateEQBand('eq12k', this.value)">
                    <div class="eq-label">12kHz</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" id="eq14k" min="-12" max="12" value="0" orient="vertical" oninput="updateEQBand('eq14k', this.value)">
                    <div class="eq-label">14kHz</div>
                </div>
                <div class="eq-band">
                    <input type="range" class="eq-slider" id="eq16k" min="-12" max="12" value="0" orient="vertical" oninput="updateEQBand('eq16k', this.value)">
                    <div class="eq-label">16kHz</div>
                </div>
            </div>
        </div>

        <div class="setting-group">
            <h3>üé® Visual & Interface</h3>
            
            <div class="setting-item">
                <div class="setting-label">
                    <h4>Custom Themes</h4>
                    <p>Enable custom color themes</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="customThemes">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item" id="themeSelector" style="display: none;">
                <div class="setting-label">
                    <h4>Theme Selection</h4>
                    <p>Choose your preferred color theme</p>
                </div>
                <select id="theme-select" style="padding: 8px; border-radius: 6px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
                    <option value="default">Default Blue</option>
                    <option value="dark">Dark Purple</option>
                    <option value="light">Light Mode</option>
                    <option value="synthwave">Synthwave</option>
                    <option value="nature">Nature Green</option>
                </select>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>Animated Background</h4>
                    <p>Show animated backgrounds</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="animatedBackground" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>Visualizer</h4>
                    <p>Show audio visualizer</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="visualizer">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>Mini Player</h4>
                    <p>Open compact mini player window</p>
                </div>
                <button class="action-btn" onclick="openMiniPlayer()" style="background: #4ecdc4; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    Open Mini Player
                </button>
            </div>
        </div>

        <div class="setting-group">
            <h3>üîî Notifications & Feedback</h3>
            
            <div class="setting-item">
                <div class="setting-label">
                    <h4>Desktop Notifications</h4>
                    <p>Show notifications for track changes</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="desktopNotifications" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>Last.fm Scrobbling</h4>
                    <p>Scrobble tracks to Last.fm</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="lastfmScrobbling">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <h4>Haptic Feedback</h4>
                    <p>Vibration feedback for actions</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="hapticFeedback">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="buttons">
            <button class="btn" onclick="saveSettings()">Save Changes</button>
            <button class="btn secondary" onclick="resetSettings()">Reset to Default</button>
        </div>
    </div>

    <script>
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Loading settings...');
            
            try {
                // Check if electronAPI is available
                if (!window.electronAPI) {
                    console.error('electronAPI is not available!');
                    alert('Settings cannot load: electronAPI is not available');
                    return;
                }
                
                console.log('electronAPI available:', Object.keys(window.electronAPI));
                
                const settings = await window.electronAPI.getAllSettings();
                console.log('Settings loaded from main process:', settings);
                
                // Load all settings dynamically
                Object.keys(settings).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = settings[key];
                        } else {
                            element.value = settings[key];
                        }
                        console.log(`Loaded setting ${key}:`, settings[key]);
                    } else {
                        console.warn(`Element not found for setting: ${key}`);
                    }
                });

                console.log('All settings loaded successfully');

                // Update theme selector visibility based on custom themes setting
                const customThemesElement = document.getElementById('customThemes');
                const themeSelector = document.getElementById('themeSelector');
                if (customThemesElement && themeSelector) {
                    themeSelector.style.display = customThemesElement.checked ? 'flex' : 'none';
                }

                // Load selected theme
                const themeSelect = document.getElementById('theme-select');
                if (themeSelect && settings.selectedTheme) {
                    themeSelect.value = settings.selectedTheme;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                alert('Error loading settings: ' + error.message);
            }
        });

        async function saveSettings() {
            console.log('Save button clicked - starting save process...');
            
            try {
                // Check if electronAPI is available
                if (!window.electronAPI) {
                    console.error('electronAPI is not available!');
                    alert('Cannot save settings: electronAPI is not available');
                    return;
                }
                
                // Get all form elements and build settings object
                const settings = {};
                
                // Define all the setting IDs that match main.js defaultSettings
                const settingIds = [
                    'backgroundPlay', 'autoPauseOnInterruption', 'crossfade', 'gaplessPlayback',
                    'startWithWindows', 'systemTray', 'mediaKeys', 'discordRichPresence',
                    'equalizerEnabled', 'audioNormalization', 'bassBoost',
                    'customThemes', 'animatedBackground', 'visualizer', 'miniPlayer',
                    'desktopNotifications', 'lastfmScrobbling', 'hapticFeedback'
                ];

                // Collect all settings
                settingIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.type === 'checkbox') {
                            settings[id] = element.checked;
                        } else if (element.type === 'range') {
                            settings[id] = parseInt(element.value);
                        } else {
                            settings[id] = element.value;
                        }
                        console.log(`Collected setting ${id}:`, settings[id]);
                    } else {
                        console.warn(`Element not found for setting: ${id}`);
                    }
                });

                // Save equalizer settings
                const eqBands = ['eq60', 'eq170', 'eq310', 'eq600', 'eq1k', 'eq3k', 'eq6k', 'eq12k', 'eq14k', 'eq16k'];
                eqBands.forEach(band => {
                    const element = document.getElementById(band);
                    if (element) {
                        settings[band] = parseInt(element.value);
                        console.log(`Collected EQ setting ${band}:`, settings[band]);
                    }
                });

                console.log('All settings collected:', settings);
                console.log('Calling saveSettings API...');

                // Save all settings
                const result = await window.electronAPI.saveSettings(settings);
                console.log('Save result:', result);

                // Initialize features based on settings
                if (settings.discordRichPresence) {
                    await window.electronAPI.initializeDiscordRPC();
                    console.log('üéÆ Discord Rich Presence initialized');
                }

                if (settings.lastfmScrobbling) {
                    await window.electronAPI.initializeLastfm();
                    console.log('üéµ Last.fm scrobbling initialized');
                }

                if (settings.equalizerEnabled) {
                    await window.electronAPI.setupEqualizer();
                    console.log('üéõÔ∏è Equalizer initialized');
                }

                // Apply audio enhancements
                if (settings.audioNormalization) {
                    await window.electronAPI.applyAudioEnhancement('normalization', true);
                    console.log('üîä Audio normalization applied');
                }

                if (settings.bassBoost > 0) {
                    await window.electronAPI.applyAudioEnhancement('bassBoost', settings.bassBoost);
                    console.log(`üéµ Bass boost applied: ${settings.bassBoost}dB`);
                }

                if (settings.crossfade) {
                    await window.electronAPI.applyAudioEnhancement('crossfade', true);
                    console.log('üéµ Crossfade enabled');
                }

                console.log('All features initialized successfully!');

                // Show feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ All Features Activated!';
                btn.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
                }, 3000);

            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings: ' + error.message);
            }
        }

        async function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default?')) {
                console.log('Resetting settings...');
                
                // Reset to default values matching main.js defaultSettings
                document.getElementById('backgroundPlay').checked = true;
                document.getElementById('autoPauseOnInterruption').checked = true;
                document.getElementById('crossfade').checked = false;
                document.getElementById('gaplessPlayback').checked = true;
                
                document.getElementById('startWithWindows').checked = false;
                document.getElementById('systemTray').checked = true;
                document.getElementById('mediaKeys').checked = true;
                document.getElementById('discordRichPresence').checked = false;
                
                document.getElementById('equalizerEnabled').checked = false;
                document.getElementById('audioNormalization').checked = true;
                document.getElementById('bassBoost').value = 0;
                
                document.getElementById('customThemes').checked = false;
                document.getElementById('animatedBackground').checked = true;
                document.getElementById('visualizer').checked = false;
                
                document.getElementById('desktopNotifications').checked = true;
                document.getElementById('lastfmScrobbling').checked = false;
                document.getElementById('hapticFeedback').checked = false;

                // Reset equalizer
                const eqBands = ['eq60', 'eq170', 'eq310', 'eq600', 'eq1k', 'eq3k', 'eq6k', 'eq12k', 'eq14k', 'eq16k'];
                eqBands.forEach(band => {
                    const slider = document.getElementById(band);
                    if (slider) slider.value = 0;
                });

                await saveSettings();
                console.log('Settings reset to default');
            }
        }

        // Real-time EQ adjustment
        async function updateEQBand(band, value) {
            try {
                if (window.electronAPI) {
                    await window.electronAPI.updateEqualizerBand(band, parseInt(value));
                    console.log(`üéõÔ∏è Updated ${band} to ${value}dB`);
                }
            } catch (error) {
                console.error('Error updating EQ band:', error);
            }
        }

        // Real-time feature toggles
        async function toggleFeature(featureName, enabled) {
            try {
                if (!window.electronAPI) {
                    console.error('electronAPI not available');
                    return;
                }

                switch (featureName) {
                    case 'discordRichPresence':
                        if (enabled) {
                            await window.electronAPI.initializeDiscordRPC();
                            console.log('üéÆ Discord Rich Presence enabled');
                        } else {
                            await window.electronAPI.destroyDiscordRPC();
                            console.log('üéÆ Discord Rich Presence disabled');
                        }
                        break;

                    case 'lastfmScrobbling':
                        if (enabled) {
                            await window.electronAPI.initializeLastfm();
                            console.log('üéµ Last.fm scrobbling enabled');
                        }
                        break;

                    case 'equalizerEnabled':
                        if (enabled) {
                            await window.electronAPI.setupEqualizer();
                            console.log('üéõÔ∏è Equalizer enabled');
                        }
                        break;

                    case 'audioNormalization':
                        await window.electronAPI.applyAudioEnhancement('normalization', enabled);
                        console.log(`üîä Audio normalization ${enabled ? 'enabled' : 'disabled'}`);
                        break;

                    case 'crossfade':
                        await window.electronAPI.applyAudioEnhancement('crossfade', enabled);
                        console.log(`üéµ Crossfade ${enabled ? 'enabled' : 'disabled'}`);
                        break;

                    case 'visualizer':
                        if (enabled) {
                            await window.electronAPI.setupVisualizer();
                            console.log('üéµ Audio visualizer enabled');
                        } else {
                            await window.electronAPI.destroyVisualizer();
                            console.log('üéµ Audio visualizer disabled');
                        }
                        break;

                    case 'hapticFeedback':
                        await window.electronAPI.applyHapticFeedback(enabled);
                        console.log(`üì≥ Haptic feedback ${enabled ? 'enabled' : 'disabled'}`);
                        break;

                    case 'autoPauseOnInterruption':
                        await window.electronAPI.applyAutoPause(enabled);
                        console.log(`‚è∏Ô∏è Auto-pause on interruption ${enabled ? 'enabled' : 'disabled'}`);
                        break;

                    case 'gaplessPlayback':
                        await window.electronAPI.applyGaplessPlayback(enabled);
                        console.log(`üîÑ Gapless playback ${enabled ? 'enabled' : 'disabled'}`);
                        break;

                    case 'customThemes':
                        // Theme selector will be shown/hidden by separate event listener
                        console.log(`üé® Custom themes ${enabled ? 'enabled' : 'disabled'}`);
                        break;

                    case 'animatedBackground':
                        // This is handled automatically by the main process
                        console.log(`üé® Animated background ${enabled ? 'enabled' : 'disabled'}`);
                        break;

                    case 'backgroundPlay':
                        await window.electronAPI.toggleBackgroundPlay(enabled);
                        console.log(`üîã Background playback ${enabled ? 'enabled' : 'disabled'}`);
                        break;

                    case 'systemTray':
                        console.log(`üîî System tray ${enabled ? 'enabled' : 'disabled'}`);
                        break;

                    case 'mediaKeys':
                        console.log(`üéπ Media keys ${enabled ? 'enabled' : 'disabled'}`);
                        break;

                    case 'desktopNotifications':
                        console.log(`üì¢ Desktop notifications ${enabled ? 'enabled' : 'disabled'}`);
                        break;

                    case 'startWithWindows':
                        console.log(`üöÄ Start with Windows ${enabled ? 'enabled' : 'disabled'}`);
                        break;

                    default:
                        console.log(`Setting ${featureName} changed to:`, enabled);
                }

                // Save setting immediately
                await window.electronAPI.setSetting(featureName, enabled);
                console.log(`üíæ Saved ${featureName}:`, enabled);
            } catch (error) {
                console.error(`Error toggling ${featureName}:`, error);
                // Show user-friendly error message
                alert(`Failed to update ${featureName}. Please try again.`);
            }
        }

        // Add event listeners for real-time toggles
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìã Settings page loaded');
            
            // Check if electronAPI is available
            if (!window.electronAPI) {
                console.error('‚ùå electronAPI not available!');
                alert('Error: Settings functionality not available. Please restart the application.');
                return;
            } else {
                console.log('‚úÖ electronAPI is available');
            }

            // Load current settings first
            try {
                await loadSettings();
                console.log('‚úÖ Settings loaded successfully');
            } catch (error) {
                console.error('‚ùå Failed to load settings:', error);
            }
            // Add change listeners to checkboxes for instant feedback
            const featureToggles = [
                'backgroundPlay', 'autoPauseOnInterruption', 'crossfade', 'gaplessPlayback',
                'startWithWindows', 'systemTray', 'mediaKeys', 'discordRichPresence',
                'equalizerEnabled', 'audioNormalization',
                'customThemes', 'animatedBackground', 'visualizer',
                'desktopNotifications', 'lastfmScrobbling', 'hapticFeedback'
            ];

            featureToggles.forEach(feature => {
                const element = document.getElementById(feature);
                if (element) {
                    element.addEventListener('change', (e) => {
                        console.log(`Feature ${feature} changed to:`, e.target.checked);
                        toggleFeature(feature, e.target.checked);
                    });
                    console.log(`‚úÖ Added listener for ${feature}`);
                } else {
                    console.warn(`‚ö†Ô∏è Element not found for feature: ${feature}`);
                }
            });

            // Add EQ band listeners
            const eqBands = ['eq60', 'eq170', 'eq310', 'eq600', 'eq1k', 'eq3k', 'eq6k', 'eq12k', 'eq14k', 'eq16k'];
            eqBands.forEach(band => {
                const slider = document.getElementById(band);
                if (slider) {
                    slider.addEventListener('input', async (e) => {
                        try {
                            const value = parseInt(e.target.value);
                            await updateEQBand(band, value);
                            await window.electronAPI.setSetting(band, value);
                        } catch (error) {
                            console.error(`Error updating ${band}:`, error);
                        }
                    });
                    console.log(`‚úÖ Added EQ listener for ${band}`);
                } else {
                    console.warn(`‚ö†Ô∏è EQ slider not found: ${band}`);
                }
            });

            // Theme selector functionality
            const customThemesToggle = document.getElementById('customThemes');
            const themeSelector = document.getElementById('themeSelector');
            const themeSelect = document.getElementById('theme-select');

            // Show/hide theme selector based on custom themes toggle
            if (customThemesToggle && themeSelector) {
                customThemesToggle.addEventListener('change', (e) => {
                    themeSelector.style.display = e.target.checked ? 'flex' : 'none';
                    console.log(`üé® Theme selector ${e.target.checked ? 'shown' : 'hidden'}`);
                });
                console.log('‚úÖ Theme toggle listener added');
            } else {
                console.warn('‚ö†Ô∏è Theme selector elements not found');
            }

            // Handle theme selection
            if (themeSelect) {
                themeSelect.addEventListener('change', async (e) => {
                    try {
                        const selectedTheme = e.target.value;
                        if (window.electronAPI) {
                            await window.electronAPI.applyCustomTheme(selectedTheme);
                            await window.electronAPI.setSetting('selectedTheme', selectedTheme);
                            console.log(`üé® Theme changed to: ${selectedTheme}`);
                        }
                    } catch (error) {
                        console.error('Error changing theme:', error);
                    }
                });

                // Load saved theme
                try {
                    const savedTheme = await window.electronAPI.getSetting('selectedTheme', 'dark');
                    themeSelect.value = savedTheme;
                    console.log(`üé® Loaded saved theme: ${savedTheme}`);
                } catch (error) {
                    console.error('Error loading saved theme:', error);
                }
                console.log('‚úÖ Theme selector listener added');
            } else {
                console.warn('‚ö†Ô∏è Theme select element not found');
            }

            // Add change listener for bass boost
            const bassBoostSlider = document.getElementById('bassBoost');
            if (bassBoostSlider) {
                bassBoostSlider.addEventListener('input', async (e) => {
                    try {
                        const value = parseInt(e.target.value);
                        if (window.electronAPI) {
                            await window.electronAPI.applyAudioEnhancement('bassBoost', value);
                            await window.electronAPI.setSetting('bassBoost', value);
                            console.log(`üéµ Bass boost set to ${value}dB`);
                        }
                    } catch (error) {
                        console.error('Error updating bass boost:', error);
                    }
                });
                console.log('‚úÖ Bass boost slider listener added');
            } else {
                console.warn('‚ö†Ô∏è Bass boost slider not found');
            }

            console.log('üéâ All settings event listeners initialized successfully');
        });

        // Mini Player function
        async function openMiniPlayer() {
            try {
                if (window.electronAPI) {
                    await window.electronAPI.openMiniPlayer();
                    console.log('üì± Mini player opened');
                } else {
                    console.error('ElectronAPI not available');
                }
            } catch (error) {
                console.error('Error opening mini player:', error);
            }
        }
    </script>
</body>
</html>
